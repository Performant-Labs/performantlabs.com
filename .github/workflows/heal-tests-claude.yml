name: (Heal) AI Test Healer via Claude
run-name: "Claude is healing test failures on issue #${{ github.event.issue.number }}"

# Trigger when an issue is created with 'auto-heal' label
# NOTE: only 'opened' — not 'labeled' — to prevent duplicate runs (each label fires a separate event)
on:
  issues:
    types: [opened]

jobs:
  heal-tests:
    # Only run if the issue has the 'auto-heal' label
    if: contains(github.event.issue.labels.*.name, 'auto-heal')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Extract branch from issue
        id: get-branch
        run: |
          BRANCH=$(echo "${{ github.event.issue.body }}" | grep -oP '(?<=Branch: )\S+' || echo "")
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Extracted branch: ${BRANCH:-default}"

      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get-branch.outputs.branch || github.event.repository.default_branch }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install NPM dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Heal tests with Claude
        continue-on-error: true
        timeout-minutes: 10
        uses: anthropics/claude-code-action@v1
        env:
          BASE_URL: https://live-performant-labs.pantheonsite.io
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          base_branch: ${{ steps.get-branch.outputs.branch || github.event.repository.default_branch }}
          show_full_output: false
          track_progress: true
          additional_permissions: |
            actions: read
          claude_args: |
            --allowedTools "Bash(npx *),Bash(npm *),Bash(git *),Bash(cat *),Bash(ls *),Bash(grep *),Bash(find *),Bash(head *),Bash(tail *),Bash(sed *),Edit,Replace,WebFetch"
            --disallowedTools "AskUserQuestion"
            --max-turns 15
          prompt: |
            You are the Playwright Test Healer for a Drupal website.

            A nightly CI run has failed. Here is the GitHub issue:

            **Issue #${{ github.event.issue.number }}:** ${{ github.event.issue.title }}

            **Issue body:**
            ${{ github.event.issue.body }}

            **Environment:**
            - BASE_URL is already set to https://live-performant-labs.pantheonsite.io
            - Do NOT prefix commands with BASE_URL=..., it's already in the environment
            - Do NOT use shell pipes, redirects, heredocs, or newlines in commands — every command must be a single line
            - For multi-part git commit messages, use multiple -m flags (each is a separate paragraph). Example: git commit -m "Fix typo COTACT to CONTACT" -m "Fixes #182"
            - This is a FULLY AUTOMATED workflow. NEVER ask questions. All info you need is in the issue body above.

            **Your task:**
            1. Read CLAUDE.md in the repo root for project-specific patterns and guidelines
            2. Identify which test file(s) are failing from the issue body
            3. Read the failing test file(s) and analyze the code for obvious bugs (typos, wrong selectors, stale URLs, etc.)
            4. Determine if each failure is a TEST ISSUE or WEBSITE ISSUE using the decision framework in CLAUDE.md
            5. For TEST issues with an obvious fix: fix the code FIRST, then run the test to verify your fix passes
            6. For TEST issues where cause is unclear: run the test to see the failure, then fix and re-run to verify
            7. When running tests, run ONLY the specific failing file: `npx playwright test <path-to-failing-test> --reporter=list`
               Do NOT run `npx playwright test` without specifying the file — that runs ALL tests
            8. For TEST issues: commit and push to create a PR
            9. For WEBSITE issues: add your analysis as your final response, do NOT modify tests
            10. Reference this issue number (#${{ github.event.issue.number }}) in your analysis

      - name: Create PR automatically
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Find the claude branch that was just created
          CLAUDE_BRANCH=$(git branch -r | grep "origin/claude/issue-${{ github.event.issue.number }}" | sed 's|origin/||' | head -1 | xargs)
          
          if [ -z "$CLAUDE_BRANCH" ]; then
            echo "No claude branch found for issue #${{ github.event.issue.number }}"
            exit 0
          fi
          
          echo "Found branch: $CLAUDE_BRANCH"
          
          # Get base branch from the issue body
          BASE_BRANCH=$(echo "${{ github.event.issue.body }}" | grep -oP 'Branch: \K[^\s]+' || echo "main")
          echo "Base branch: $BASE_BRANCH"
          
          # Create PR
          gh pr create \
            --base "$BASE_BRANCH" \
            --head "$CLAUDE_BRANCH" \
            --title "Fix: Test healing for issue #${{ github.event.issue.number }}" \
            --body "Automated fix by Claude Code for issue #${{ github.event.issue.number }}.

          See the issue comment for full analysis and changes.
          
          Fixes #${{ github.event.issue.number }}" \
            || echo "PR creation failed or PR already exists"
