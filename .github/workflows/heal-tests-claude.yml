name: (Heal) AI Test Healer via Claude
run-name: Claude is healing test failures on issue #${{ github.event.issue.number }}

# Trigger when an issue is created or labeled with 'auto-heal'
on:
  issues:
    types: [opened, labeled]

jobs:
  heal-tests:
    # Only run if the issue has the 'auto-heal' label
    if: contains(github.event.issue.labels.*.name, 'auto-heal')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Extract branch from issue
        id: get-branch
        run: |
          BRANCH=$(echo "${{ github.event.issue.body }}" | grep -oP '(?<=Branch: )\S+' || echo "")
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Extracted branch: ${BRANCH:-default}"

      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get-branch.outputs.branch || github.event.repository.default_branch }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install NPM dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Heal tests with Claude
        timeout-minutes: 10
        uses: anthropics/claude-code-action@v1
        env:
          BASE_URL: https://live-performant-labs.pantheonsite.io
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          additional_permissions: |
            actions: read
          claude_args: |
            --allowedTools "Bash(npx *),Bash(npm *),Bash(gh *),Bash(cat *),Bash(ls *),Bash(grep *),Bash(find *),Bash(head *),Bash(tail *),Bash(sed *),Edit,Replace,WebFetch"
            --disallowedTools "AskUserQuestion"
            --max-turns 10
          prompt: |
            You are the Playwright Test Healer for a Drupal website.

            A nightly CI run has failed. Here is the GitHub issue:

            **Issue #${{ github.event.issue.number }}:** ${{ github.event.issue.title }}

            **Issue body:**
            ${{ github.event.issue.body }}

            **Environment:**
            - BASE_URL is already set to https://live-performant-labs.pantheonsite.io
            - Do NOT prefix commands with BASE_URL=..., it's already in the environment
            - Do NOT use shell pipes, redirects, or heredocs — run simple single commands only
            - Do NOT use `git commit` or `git push` directly — the action handles commits and PRs for you
            - This is a FULLY AUTOMATED workflow. NEVER ask questions. All info you need is in the issue body above.

            **Your task:**
            1. Identify which test file(s) are failing from the issue body
            2. Read the failing test file(s) to understand the test
            3. Run ONLY the specific failing test file: `npx playwright test <path-to-failing-test> --reporter=list`
               Do NOT run `npx playwright test` without specifying the file — that runs ALL tests
            4. Analyze the failures using the decision framework in CLAUDE.md
            5. Determine if each failure is a TEST ISSUE or WEBSITE ISSUE
            6. For TEST issues: fix the test code and create a PR
            7. For WEBSITE issues: comment your analysis on this issue but do NOT modify tests
            8. If creating a PR, reference this issue number (#${{ github.event.issue.number }}) in it

            Read CLAUDE.md in the repo root for project-specific patterns and guidelines.
