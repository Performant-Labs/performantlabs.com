name: Add PR Comment

on:
  repository_dispatch:
    types: [add-pr-comment-command]
  pull_request:
    types: [opened, synchronize, reopened]
    
jobs:
  add_comment:
    runs-on: ubuntu-latest
    # Do this only if the PR was created by dependabot
    # if: github.event.client_payload.pull_request.user.login == 'dependabot[bot]'
    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Client_payload when coming from repository dispatch.
        run: |
          PULL_REQUEST=${{ github.event.client_payload.pull_request }}
          if [ "$PULL_REQUEST" != "" ]; then
            PULL_REQUEST=toJson($PULL_REQUEST)
            echo "$PULL_REQUEST" | jq
          else
            echo "Pull request is empty."
          fi
          exit 1
        
#          USER_LOGIN=${{ fromJson(github.event.client_payload.pull_request).user.login }}
#          if [ "$USER_LOGIN" != "" ]; then
#            echo "User.login: $USER_LOGIN"
#          else
#            echo "User.login path is not valid or the field is empty"
#          fi
#          exit 1
 #         PULL_REQUEST=${{ toJson(github.event.client_payload.pull_request) }}
 #         if [ "$PULL_REQUEST" != "" ]; then
 #           echo "$PULL_REQUEST" | jq
 #         else
 #           echo "Pull request is empty."
 #         fi

#      - name: github.event.pull_request when coming from open, reopen, synchronize.
#        run: |
#          PULL_REQUEST=${{ toJson(github.event.client_payload.pull_request) }}
#          if [ "$PULL_REQUEST" != "" ]; then
#            echo "$PULL_REQUEST" | jq
#          else
#            echo "Pull request is empty."
#          fi
#          exit 1
        
      - name: Must be triggered by a command or is a PR created by Dependabot.
        run: |
          echo "User login: ${{ github.event.pull_request.user.login }} "
          echo "Github Event_name: ${{ github.event_name }} "
          echo "Github event.action: ${{ github.event.action }} "
        
          if [ 
          
          !(("${{ github.event_name }}" = "repository_dispatch" ] && [ "${{ github.event.action }}" = "add-pr-comment-command") 
          ||
          ("${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.user.login }}" = "dependabot[bot]"))
          
          ]; then
            echo "Test criteria failed. Exiting..."
            exit 1
          fi
      
      - name: Trigger the visual testing
        uses: peter-evans/create-or-update-comment@v2
        with:
          token: ${{ secrets.GH_PAT }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
          body: |
            The test criteria passed.
