name: Add PR Comment

on:
  repository_dispatch:
    types: [add-pr-comment-command]
  pull_request:
    types: [opened, synchronize, reopened]
    
jobs:
  add_comment:
    runs-on: ubuntu-latest
    # Do this only if the PR was created by dependabot
    # if: github.event.client_payload.pull_request.user.login == 'dependabot[bot]'
    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
          PULL_REQUEST: ${{ toJson(github.event.client_payload.pull_request) }}
          
        run: |
          echo "$PULL_REQUEST"
          exit 1
        
      - name: Client_payload when coming from repository dispatch.
        run: |
          EVENT_NAME=${{ github.event_name }}
          EVENT_ACTION=${{ github.event.action }}
          # Will be "pull_request" or "reposity_dispatch".

          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "Event is repository_dispatch, proceeding..."
            PULL_REQUEST=${{ github.event.client_payload.pull_request }}
            USER_LOGIN=${{ github.event.client_payload.pull_request.user.login }}
            
          elif [ "${{ github.event_name }}" == "pull_request" ] && [ "${{ github.event.pull_request.user.login }}" == "dependabot[bot]" ]; then
            echo "Event is a pull_request from dependabot, proceeding..."
            PULL_REQUEST=${{ github.event.pull_request }}
            USER_LOGIN=${{ github.event.pull_request.user.login }}  
            
          else
            echo "Test criteria failed. Exiting..."
            exit 1
          fi

          echo "Event_name: ${{ github.event_name }}"
          echo "User login: ${USER_LOGIN}" 
      
      - name: Trigger the visual testing
        uses: peter-evans/create-or-update-comment@v2
        with:
          token: ${{ secrets.GH_PAT }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
          body: |
            The test criteria passed.
